<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Rider - Due</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link
		href="https://fonts.googleapis.com/css?family=Poppins:100,100italic,200,200italic,300,300italic,regular,italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic"
		rel="stylesheet" />
	<style>
		body {
			font-family: 'Poppins' !important;
		}
	</style>
</head>

<body onload="handleLoading()" class="bg-yellow-50 flex justify-center items-center h-screen w-screen">
	<form class="bg-white border-yellow-400 border-2 rounded-xl p-6 lg:w-1/3 w-[90%] shadow-xl flex flex-col">
		<h1 class="text-center font-bold text-2xl mb-4">Initiating Transaction</h1>
		<div class="flex flex-col">
			<input id="txn" placeholder="Txn ID"
				class="outline-none border-2 border-yellow-400 rounded-lg bg-white px-4 py-3">
			<input id="amount" placeholder="Order money"
				class="mt-3 outline-none border-2 border-yellow-400 rounded-lg bg-white px-4 py-3">
		</div>
	</form>


	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
		integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous">
		</script>
	<script type="module" src="https://uat1.billdesk.com/merchant-
	uat/sdk/dist/billdesksdk/billdesksdk.esm.js"></script>
	<script nomodule="" src="https://uat1.billdesk.com/merchant-uat/sdk/dist/billdesksdk.js"></script>
	<link href="https://uat1.billdesk.com/merchant-uat/sdk/dist/billdesksdk/billdesksdk.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"
		integrity="sha512-b94Z6431JyXY14iSXwgzeZurHHRNkLt9d6bAHt7BZT38eqV+GyngIi/tVye4jBKPYQ2lBdRs0glww4fmpuLRwA=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>
		let url = new URL(window.location.href);
		let search_params = url.searchParams;
		var responseHandler = function () {
			if (txn.status === 200) {
				axios(`https://instaport-backend-main.vercel.app/rider/app-payment/`, {
					method: "POST",
					headers: {
						"authorization": `Bearer ${search_params.get("token")}`
					},
					data: {
						transaction: txn.txnResponse.transaction_response,
					}
				})
					.then((res) => {
						console.log("res", res.data.message, txn.txnResponse.transaction_response)
						// alert("transaction sucess")
					})
					.catch((err) => {
						alert("error:", err.message)
					})
			}
		}
		const handleLoading = () => {
			document.getElementById("amount").value = search_params.get("amount")
			handleDuePayment();
		}
		const handleDuePayment = () => {
			let ip = "";
			fetch('https://api.ipify.org?format=json')
				.then(response => response.json())
				.then((data) => {
					ip = data.ip
				});
			axios("https://instaport-backend-main.vercel.app/auth/payment-dues-rider", {
				method: "POST",
				headers: {
					"Authorization": `Bearer ${search_params.get("token")}`
				},
				data: {
					ip: ip,
					user_agent: window.navigator.userAgent,
					amount: search_params.get("amount"),
				},
			})
				.then((res) => {
					console.log(res.data)
					var flow_config = {
						merchantId: "UATINSPTV2",
						bdOrderId: res.data.bdorderid,
						authToken: res.data.authorization,
						returnUrl: `https://instaport-backend-main.vercel.app/rider/app-payment/`,
						childWindow: false,
						retryCount: 0,
						prefs: {
							"payment_categories": ["card", "upi", "qr"],
						},
						themeConfig: {
							sdkPrimaryColor: "#69068a",
							sdkAccentColor: "#cf5df5",
							sdkBackgroundColor: "#f2caff",
							sdkBannerColor: "#982cbb"
						}
					};

					var config = {
						merchantLogo: "https://instaportdelivery.com/assets/logo/logo.png",
						flowConfig: flow_config,
						flowType: "payments",
						responseHandler: responseHandler,
					};

					var xmlhttp = new XMLHttpRequest();
					var jsonObj = "";
					{
						window.loadBillDeskSdk(config);
					};
				})
				.catch((err) => {
					console.log(err)
				})

		}
	</script>
</body>

</html>